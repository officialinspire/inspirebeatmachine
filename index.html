<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSPIRE | BEAT MACHINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Base and Typography */
        :root {
            --primary-color: #00ffe5;
            --secondary-color: #ff00a0;
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-light: #1e1e1e;
            --text-color: #ffffff;
            --border-glow: 0 0 10px var(--primary-color);
            --grid-bg: rgba(10, 10, 15, 0.95);
            --grid-border: #2a2a3a;
            --button-active: var(--primary-color);
            --button-hover: rgba(0, 255, 229, 0.2);
            --button-ticked: #00ff9d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            padding: 20px;
        }

        body:before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                ),
                radial-gradient(
                    circle at 50% 50%,
                    rgba(0, 0, 255, 0.05) 0%,
                    rgba(0, 0, 0, 0) 70%
                );
            z-index: -1;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }

        .app-title {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color);
            margin-bottom: 2rem;
            letter-spacing: 2px;
            text-align: center;
        }

        /* Control Panel */
        .control-panel {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(0, 255, 229, 0.2);
        }

        /* Tempo Display and Controls */
        .tempo-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .tempo-display {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color);
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            min-width: 120px;
            text-align: center;
        }

        .tempo-slider-container {
            width: 300px;
            margin: 1rem 0;
        }

        .tempo-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-light);
            border-radius: 3px;
            outline: none;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary-color);
        }

        .tempo-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .tempo-btn {
            background: var(--bg-dark);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tempo-btn:hover {
            background: var(--button-hover);
            box-shadow: 0 0 8px var(--primary-color);
        }

        /* Control Buttons */
        .controls-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .control-button {
            background: var(--bg-dark);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            text-align: center;
            font-family: 'Share Tech Mono', monospace;
        }

        .control-button:hover {
            background: var(--button-hover);
            box-shadow: 0 0 10px var(--primary-color);
        }

        #play-pause {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 0;
        }

        /* Beat Grid */
        .beat-grid-container {
            width: 100%;
            border-radius: 10px;
            background: var(--grid-bg);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 229, 0.2);
            padding: 1.5rem;
            overflow-x: auto;
        }

        .beat-grid {
            display: grid;
            grid-template-columns: 120px repeat(16, minmax(40px, 1fr));
            gap: 6px;
            min-width: 900px;
        }

        .instrument-label {
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            padding-right: 10px;
            justify-content: flex-end;
        }

        .beat-row {
            display: contents;
        }

        .beat-cell {
            height: 30px;
            background: transparent;
            border: 2px solid var(--primary-color);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 3px rgba(0, 255, 229, 0.3);
        }

        .beat-cell:hover {
            background: var(--button-hover);
        }

        .beat-cell.on {
            background: var(--button-active);
            box-shadow: 0 0 8px var(--primary-color);
        }

        .beat-cell.ticked {
            background: var(--button-ticked);
            box-shadow: 0 0 12px var(--button-ticked);
        }

        .credits {
            margin-top: 2rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        /* Responsive styles */
        @media (max-width: 960px) {
            .control-panel {
                padding: 1.5rem 1rem;
            }
            
            .tempo-slider-container {
                width: 250px;
            }
            
            .tempo-display {
                font-size: 2.5rem;
            }
            
            .app-title {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .beat-grid-container {
                padding: 1rem 0.5rem;
            }
            
            .beat-grid {
                min-width: 700px;
            }
            
            .instrument-label {
                font-size: 0.8rem;
            }
            
            .tempo-display {
                font-size: 2rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="app-title">INSPIRE | BEAT MACHINE</h1>
        
        <div class="control-panel">
            <div class="tempo-controls">
                <div class="tempo-display">
                    <span id="tempo-value">120</span>
                </div>
                <div class="tempo-slider-container">
                    <input type="range" min="60" max="200" value="120" class="tempo-slider" id="tempo-slider">
                </div>
                <div class="tempo-buttons">
                    <button id="tempo-down" class="tempo-btn">-</button>
                    <button id="tempo-up" class="tempo-btn">+</button>
                </div>
            </div>
            
            <div class="controls-row">
                <button id="play-pause" class="control-button">
                    <span class="pause-icon">❚❚</span>
                </button>
            </div>
            
            <div class="controls-row">
                <button id="clear" class="control-button">CLEAR</button>
                <button id="random" class="control-button">RANDOM</button>
                <button id="export" class="control-button">EXPORT</button>
                <a id="download_link" style="display:none"></a>
            </div>
        </div>
        
        <div class="beat-grid-container">
            <div class="beat-grid" id="beat-grid"></div>
        </div>
        
        <div class="credits">
            Created by INSPIRE HQ — MESHSTORM OPS
        </div>
    </div>
    
    <script>
        (function() {
          'use strict';
          var AudioContext = window.AudioContext || window.webkitAudioContext || false;

          // Default settings
          var BPM = 120;
          var TICKS = 16;
          var soundPrefix = 'https://blog.omgmog.net/beatmaker/sounds/';
          var sounds = [
            'bass_drum.wav',
            'snare_drum.wav',
            'low_tom.wav',
            'mid_tom.wav',
            'hi_tom.wav',
            'rim_shot.wav',
            'hand_clap.wav',
            'cowbell.wav',
            'cymbal.wav',
            'o_hi_hat.wav',
            'cl_hi_hat.wav',
            'low_conga.wav',
            'mid_conga.wav',
            'hi_conga.wav',
            'claves.wav',
            'maracas.wav'
          ];
          
          var buffers = {};
          var context;
          var isPlaying = true;
          var interval;
          var currentTick = 0;
          var lastTick = TICKS - 1;
          
          // Initialize audio context
          if (AudioContext) {
            context = new AudioContext();
          }

          // Initialize UI elements
          var $beatGrid = document.getElementById('beat-grid');
          var $tempoValue = document.getElementById('tempo-value');
          var $tempoSlider = document.getElementById('tempo-slider');
          var $tempoUp = document.getElementById('tempo-up');
          var $tempoDown = document.getElementById('tempo-down');
          var $playPause = document.getElementById('play-pause');
          
          // Create beat grid with HTML structure
          function createBeatGrid() {
              for (var r = 0; r < sounds.length; r++) {
                  var soundname = sounds[r].split('.')[0];
                  
                  // Create label cell
                  var labelCell = document.createElement('div');
                  labelCell.className = 'instrument-label';
                  labelCell.textContent = soundname.replace('_', ' ');
                  $beatGrid.appendChild(labelCell);
                  
                  // Create beat cells for this row
                  for (var c = 0; c < TICKS; c++) {
                      var beatCell = document.createElement('div');
                      beatCell.className = 'beat-cell';
                      beatCell.dataset.row = r;
                      beatCell.dataset.col = c;
                      beatCell.dataset.sound = soundname;
                      
                      beatCell.addEventListener('click', function() {
                          this.classList.toggle('on');
                      });
                      
                      $beatGrid.appendChild(beatCell);
                  }
              }
          }
          
          // Function to play sound
          var playSound = function (index) {
            if (!isPlaying) return;
            
            var url = soundPrefix + sounds[index];

            if (!AudioContext) {
              new Audio(url).play();
              return;
            }
            
            if (typeof(buffers[url]) == 'undefined') {
              buffers[url] = null;
              var req = new XMLHttpRequest();
              req.open('GET', url, true);
              req.responseType = 'arraybuffer';

              req.onload = function () {
                context.decodeAudioData(req.response,
                  function (buffer) {
                    buffers[url] = buffer;
                    playBuffer(buffer);
                  },
                  function (err) {
                    console.log(err);
                  }
                );
              };
              req.send();
            }
            
            function playBuffer(buffer) {
              var source = context.createBufferSource();
              source.buffer = buffer;
              source.connect(context.destination);
              source.start();
            };
            
            if (buffers[url]) {
              playBuffer(buffers[url]);
            }
          };
          
          // Create the grid
          createBeatGrid();
          
          // Get all beat cells
          var $beatCells = document.querySelectorAll('.beat-cell');

          // Clear grid
          var clearBeat = function() {
            var $onbeats = document.querySelectorAll('.beat-cell.on');
            if (!$onbeats.length) return;
            
            for (var i = 0; i < $onbeats.length; i++) {
              $onbeats[i].classList.remove('on');
            }
          };
          document.querySelector('#clear').addEventListener('click', clearBeat);

          // Generate random pattern
          var setRandomBeat = function() {
            clearBeat();

            for (var r = 0; r < sounds.length; r++) {
              for (var c = 0; c < TICKS; c++) {
                var cell = document.querySelector(`.beat-cell[data-row="${r}"][data-col="${c}"]`);
                var num = Math.ceil(Math.random() * 100) % 3;
                if (num === 0 && cell) {
                  cell.classList.add('on');
                }
              }
            }
          };
          document.querySelector('#random').addEventListener('click', setRandomBeat);

          // Export pattern as JSON
          var exportBeat = function () {
            var exportData = {};
            
            for (var r = 0; r < sounds.length; r++) {
              var soundname = sounds[r].split('.')[0];
              var cellsbuffer = Array(TICKS).fill(0);
              
              for (var c = 0; c < TICKS; c++) {
                var cell = document.querySelector(`.beat-cell[data-row="${r}"][data-col="${c}"]`);
                if (cell && cell.classList.contains('on')) {
                  cellsbuffer[c] = 1;
                }
              }
              
              // Group cells in sets of 4
              var cellsgrouped = [];
              var groupsize = 4;
              
              for (var i = 0; i < cellsbuffer.length; i += groupsize) {
                cellsgrouped.push(cellsbuffer.slice(i, i + groupsize));
              }
              
              exportData[soundname] = cellsgrouped;
            }

            // create json that can be downloaded
            var data_string = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
            var download_link = document.getElementById('download_link');
            download_link.setAttribute("href", data_string);
            download_link.setAttribute("download", "tracks.json");

            // trigger download
            download_link.click();
          };
          document.querySelector('#export').addEventListener('click', exportBeat);

          // Setup tempo control
          $tempoSlider.addEventListener('input', function() {
            updateTempo(this.value);
          });
          
          $tempoUp.addEventListener('click', function() {
            var newTempo = Math.min(parseInt($tempoValue.textContent) + 5, 200);
            updateTempo(newTempo);
            $tempoSlider.value = newTempo;
          });
          
          $tempoDown.addEventListener('click', function() {
            var newTempo = Math.max(parseInt($tempoValue.textContent) - 5, 60);
            updateTempo(newTempo);
            $tempoSlider.value = newTempo;
          });
          
          function updateTempo(tempo) {
            BPM = parseInt(tempo);
            $tempoValue.textContent = BPM;
            
            // Update the playback timing
            restartSequencer();
          }
          
          // Play/Pause functionality
          $playPause.addEventListener('click', function() {
            isPlaying = !isPlaying;
            
            if (isPlaying) {
              this.innerHTML = '<span class="pause-icon">❚❚</span>';
              if (AudioContext && context.state === 'suspended') {
                context.resume();
              }
              startSequencer();
            } else {
              this.innerHTML = '<span class="play-icon">▶</span>';
              if (interval) {
                cancelAnimationFrame(interval.value);
              }
            }
          });
          
          // Handle animation frame request for timing
          function requestInterval(fn, delay) {
            var start = new Date().getTime();
            var handle = {};

            function loop() {
              var current = new Date().getTime();
              var delta = current - start;
              if (delta >= delay) {
                fn.call();
                start = new Date().getTime();
              }
              handle.value = requestAnimationFrame(loop);
            }
            handle.value = requestAnimationFrame(loop);
            return handle;
          }
          
          function startSequencer() {
            var tickTime = 60000 / (BPM * 4); // Calculate time per tick based on BPM
            
            interval = requestInterval(function() {
              for (var r = 0; r < sounds.length; r++) {
                var lastCell = document.querySelector(`.beat-cell[data-row="${r}"][data-col="${lastTick}"]`);
                var currentCell = document.querySelector(`.beat-cell[data-row="${r}"][data-col="${currentTick}"]`);
                
                if (lastCell) lastCell.classList.remove('ticked');
                if (currentCell) {
                    currentCell.classList.add('ticked');
                    if (currentCell.classList.contains('on')) {
                        playSound(r);
                    }
                }
              }
              lastTick = currentTick;
              currentTick = (currentTick + 1) % TICKS;
            }, tickTime);
          }
          
          function restartSequencer() {
            if (interval) {
              cancelAnimationFrame(interval.value);
            }
            if (isPlaying) {
              startSequencer();
            }
          }
          
          // Start the sequencer
          startSequencer();
          
          // Initial click to start audio context
          document.body.addEventListener('click', function() {
            if (context && context.state === 'suspended') {
              context.resume();
            }
          }, { once: true });
          
          // Send height to parent iframe
          function updateParentHeight() {
            const height = document.body.scrollHeight;
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({ height: height }, '*');
            }
          }
          
          // Update on load and whenever content changes
          window.addEventListener('load', updateParentHeight);
          window.addEventListener('resize', updateParentHeight);
          
          // Update periodically
          setInterval(updateParentHeight, 500);
        }());
    </script>
</body>
</html>
