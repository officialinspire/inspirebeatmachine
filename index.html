<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSPIRE | BEAT MACHINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Base and Typography */
        :root {
            --primary-color: #00ffe5;
            --secondary-color: #ff00a0;
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-light: #1e1e1e;
            --text-color: #ffffff;
            --border-glow: 0 0 10px var(--primary-color);
            --grid-bg: rgba(10, 10, 15, 0.95);
            --grid-border: #2a2a3a;
            --button-active: var(--primary-color);
            --button-hover: rgba(0, 255, 229, 0.2);
            --button-ticked: #00ff9d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            position: relative;
        }

        body:before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                ),
                radial-gradient(
                    circle at 50% 50%,
                    rgba(0, 0, 255, 0.05) 0%,
                    rgba(0, 0, 0, 0) 70%
                );
            z-index: -1;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .app-title {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color);
            margin-bottom: 2rem;
            letter-spacing: 2px;
        }

        /* Control Panel */
        .control-panel {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(0, 255, 229, 0.2);
        }

        /* Tempo Display and Controls */
        .tempo-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .tempo-display {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-color);
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            min-width: 120px;
            text-align: center;
        }

        .tempo-slider-container {
            width: 300px;
            margin: 1rem 0;
        }

        .tempo-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-light);
            border-radius: 3px;
            outline: none;
            position: relative;
        }

        .tempo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary-color);
        }

        .tempo-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .tempo-btn {
            background: var(--bg-dark);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tempo-btn:hover {
            background: var(--button-hover);
            box-shadow: 0 0 8px var(--primary-color);
        }

        /* Control Buttons */
        .button-controls {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .play-control {
            margin-bottom: 1.5rem;
        }

        .control-button {
            background: var(--bg-dark);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            text-align: center;
            font-family: 'Share Tech Mono', monospace;
        }

        .control-button:hover {
            background: var(--button-hover);
            box-shadow: 0 0 10px var(--primary-color);
        }

        #play-pause {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Beat Grid and Labels */
        .beat-container {
            width: 100%;
            display: flex;
            margin-top: 1rem;
            position: relative;
            overflow-x: auto;
        }

        .instrument-scroll {
            display: flex;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            border-radius: 10px;
            background: var(--grid-bg);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 229, 0.2);
            padding: 1.5rem;
            position: relative;
        }

        .instrument-labels {
            display: flex;
            flex-wrap: nowrap;
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 120px;
            z-index: 10;
        }

        .instrument-column {
            display: flex;
            flex-direction: column;
            min-width: 120px;
            justify-content: space-around;
            padding: 1.5rem 0;
        }

        .instrument-label {
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
            height: 30px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .grid-wrapper {
            margin-left: 120px;
            flex: 1;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(16, minmax(40px, 1fr));
            grid-auto-rows: 30px;
            gap: 8px;
            min-width: 800px;
        }

        .grid button {
            background: transparent;
            border: 2px solid var(--primary-color);
            padding: 0;
            position: relative;
            outline: none;
            border-radius: 3px;
            transition: all 0.2s ease;
            box-shadow: 0 0 3px rgba(0, 255, 229, 0.3);
        }

        .grid button:hover {
            background: var(--button-hover);
        }

        .grid button.on {
            background: var(--button-active);
            box-shadow: 0 0 8px var(--primary-color);
        }

        .grid button.on:hover {
            background: rgba(0, 255, 229, 0.8);
        }

        .grid button.ticked {
            background: var(--button-ticked);
            box-shadow: 0 0 12px var(--button-ticked);
        }

        .grid button.ticked:hover {
            background: rgba(0, 255, 157, 0.8);
        }

        .inspired-by {
            margin-top: 2rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        /* Responsive styles */
        @media (max-width: 960px) {
            .control-panel {
                padding: 1.5rem 1rem;
            }
            
            .tempo-slider-container {
                width: 250px;
            }
            
            .button-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 2rem;
            }
            
            .tempo-display {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="app-title">INSPIRE | BEAT MACHINE</h1>
        
        <div class="control-panel">
            <div class="tempo-controls">
                <div class="tempo-display">
                    <span id="tempo-value">120</span>
                </div>
                <div class="tempo-slider-container">
                    <input type="range" min="60" max="200" value="120" class="tempo-slider" id="tempo-slider">
                </div>
                <div class="tempo-buttons">
                    <button id="tempo-down" class="tempo-btn">-</button>
                    <button id="tempo-up" class="tempo-btn">+</button>
                </div>
            </div>
            
            <div class="play-control">
                <button id="play-pause" class="control-button">
                    <span class="pause-icon">❚❚</span>
                </button>
            </div>
            
            <div class="button-controls">
                <button id="clear" class="control-button">CLEAR</button>
                <button id="random" class="control-button">RANDOM</button>
                <button id="export" class="control-button">EXPORT</button>
                <a id="download_link" style="display:none"></a>
            </div>
        </div>
        
        <div class="beat-container">
            <div class="instrument-scroll">
                <div class="instrument-labels">
                    <div class="instrument-column">
                        <div class="instrument-label">bass_drum</div>
                        <div class="instrument-label">snare_drum</div>
                        <div class="instrument-label">low_tom</div>
                        <div class="instrument-label">mid_tom</div>
                        <div class="instrument-label">hi_tom</div>
                        <div class="instrument-label">rim_shot</div>
                        <div class="instrument-label">hand_clap</div>
                        <div class="instrument-label">cowbell</div>
                        <div class="instrument-label">cymbal</div>
                        <div class="instrument-label">o_hi_hat</div>
                        <div class="instrument-label">cl_hi_hat</div>
                        <div class="instrument-label">low_conga</div>
                        <div class="instrument-label">mid_conga</div>
                        <div class="instrument-label">hi_conga</div>
                        <div class="instrument-label">claves</div>
                        <div class="instrument-label">maracas</div>
                    </div>
                </div>
                <div class="grid-wrapper">
                    <div class="grid"></div>
                </div>
            </div>
        </div>
        
        <div class="inspired-by">
            Created by INSPIRE HQ — MESHSTORM OPS
        </div>
    </div>
    
    <script>
        (function() {
          'use strict';
          var AudioContext = window.AudioContext || window.webkitAudioContext || false;

          // Default settings
          var BPM = 120;
          var TICKS = 16;
          var soundPrefix = 'https://blog.omgmog.net/beatmaker/sounds/';
          var sounds = [
            'bass_drum.wav',
            'snare_drum.wav',
            'low_tom.wav',
            'mid_tom.wav',
            'hi_tom.wav',
            'rim_shot.wav',
            'hand_clap.wav',
            'cowbell.wav',
            'cymbal.wav',
            'o_hi_hat.wav',
            'cl_hi_hat.wav',
            'low_conga.wav',
            'mid_conga.wav',
            'hi_conga.wav',
            'claves.wav',
            'maracas.wav'
          ];
          
          var buffers = {};
          var context;
          var isPlaying = true;
          var interval;
          var currentTick = 0;
          var lastTick = TICKS - 1;
          
          // Initialize audio context
          if (AudioContext) {
            context = new AudioContext();
          }

          // Initialize UI elements
          var $grid = document.querySelector('.grid');
          var $tempoValue = document.getElementById('tempo-value');
          var $tempoSlider = document.getElementById('tempo-slider');
          var $tempoUp = document.getElementById('tempo-up');
          var $tempoDown = document.getElementById('tempo-down');
          var $playPause = document.getElementById('play-pause');
          
          // Function to play sound
          var playSound = function (index) {
            if (!isPlaying) return;
            
            var url = soundPrefix + sounds[index];

            if (!AudioContext) {
              new Audio(url).play();
              return;
            }
            
            if (typeof(buffers[url]) == 'undefined') {
              buffers[url] = null;
              var req = new XMLHttpRequest();
              req.open('GET', url, true);
              req.responseType = 'arraybuffer';

              req.onload = function () {
                context.decodeAudioData(req.response,
                  function (buffer) {
                    buffers[url] = buffer;
                    playBuffer(buffer);
                  },
                  function (err) {
                    console.log(err);
                  }
                );
              };
              req.send();
            }
            
            function playBuffer(buffer) {
              var source = context.createBufferSource();
              source.buffer = buffer;
              source.connect(context.destination);
              source.start();
            };
            
            if (buffers[url]) {
              playBuffer(buffers[url]);
            }
          };
          
          // Create grid buttons
          var slength = sounds.length;
          var $button = document.createElement('button');
          $button.classList.add('beat');

          for (var r = 0; r < slength; r++) {
            for (var c = 0; c < TICKS; c++) {
              var _$button = $button.cloneNode(true);
              if (c === 0) {
                _$button.classList.add('first');
              }
              // add a class based on the instrument
              var soundname = sounds[r].split('.')[0];
              _$button.classList.add(soundname);
              _$button.dataset.instrument = soundname;

              _$button.addEventListener('click', function() {
                this.classList.toggle('on');
              }, false);
              $grid.appendChild(_$button);
            }
          }

          var $beats = document.querySelectorAll('.beat');

          // Clear grid
          var clearBeat = function() {
            var $onbeats = document.querySelectorAll('.beat.on');
            if (!$onbeats.length) return;
            
            for (var i = 0; i < $onbeats.length; i++) {
              $onbeats[i].classList.remove('on');
            }
          };
          document.querySelector('#clear').addEventListener('click', clearBeat);

          // Generate random pattern
          var setRandomBeat = function() {
            clearBeat();

            for (var r = 0; r < slength; r++) {
              for (var c = 0; c < TICKS; c++) {
                var num = Math.ceil(Math.random() * 100) % 3;
                if (num === 0) {
                  $beats[c + (r * TICKS)].classList.toggle('on');
                }
              }
            }
          };
          document.querySelector('#random').addEventListener('click', setRandomBeat);

          // Export pattern as JSON
          var exportBeat = function () {
            // create an object so we can jsonify it later
            var exportData = {}
            // for each row (sound)
            sounds.forEach(function (sound) {
              // get the soundname, without .wav
              var soundname = sound.split('.')[0];

              // create arrays
              var cellsgrouped = [];

              // this will give us [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
              var cellsbuffer = Array.apply(null, Array(TICKS)).map(Number.prototype.valueOf,0);

              // set the size of a group
              var groupsize = 4;

              // select all of the cells in the beat maker by the current soundname
              var cells = document.querySelectorAll(`.beat.${soundname}`);

              // loop over the cells
              for (var i=0; i<cells.length;i++) {
                // if it's on, the value is 1
                if (cells[i].classList.contains('on')) {
                  cellsbuffer[i] = 1;
                }
              }
              // group the cells in to sets
              // this will give us [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]
              while (cellsbuffer.length > 0) {
                cellsgrouped.push(cellsbuffer.splice(0, groupsize));
              }
              // update the object
              exportData[soundname] = cellsgrouped;
            });

            // create json that can be downloaded
            var data_string = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
            var download_link = document.getElementById('download_link');
            download_link.setAttribute("href", data_string);
            download_link.setAttribute("download", "tracks.json");

            // trigger download
            download_link.click();
          };
          document.querySelector('#export').addEventListener('click', exportBeat);

          // Setup tempo control
          $tempoSlider.addEventListener('input', function() {
            updateTempo(this.value);
          });
          
          $tempoUp.addEventListener('click', function() {
            var newTempo = Math.min(parseInt($tempoValue.textContent) + 5, 200);
            updateTempo(newTempo);
            $tempoSlider.value = newTempo;
          });
          
          $tempoDown.addEventListener('click', function() {
            var newTempo = Math.max(parseInt($tempoValue.textContent) - 5, 60);
            updateTempo(newTempo);
            $tempoSlider.value = newTempo;
          });
          
          function updateTempo(tempo) {
            BPM = parseInt(tempo);
            $tempoValue.textContent = BPM;
            
            // Update the playback timing
            restartSequencer();
          }
          
          // Play/Pause functionality
          $playPause.addEventListener('click', function() {
            isPlaying = !isPlaying;
            
            if (isPlaying) {
              this.innerHTML = '<span class="pause-icon">❚❚</span>';
              if (AudioContext && context.state === 'suspended') {
                context.resume();
              }
              startSequencer();
            } else {
              this.innerHTML = '<span class="play-icon">▶</span>';
              if (interval) {
                cancelAnimationFrame(interval.value);
              }
            }
          });
          
          // Handle animation frame request for timing
          function requestInterval(fn, delay) {
            var start = new Date().getTime();
            var handle = {};

            function loop() {
              var current = new Date().getTime();
              var delta = current - start;
              if (delta >= delay) {
                fn.call();
                start = new Date().getTime();
              }
              handle.value = requestAnimationFrame(loop);
            }
            handle.value = requestAnimationFrame(loop);
            return handle;
          }
          
          function startSequencer() {
            var tickTime = 60000 / (BPM * 4); // Calculate time per tick based on BPM
            
            interval = requestInterval(function() {
              for (var i = 0; i < slength; i++) {
                var lastBeat = $beats[i * TICKS + lastTick];
                var currentBeat = $beats[i * TICKS + currentTick];
                
                if (lastBeat) lastBeat.classList.remove('ticked');
                if (currentBeat) {
                    currentBeat.classList.add('ticked');
                    if (currentBeat.classList.contains('on')) {
                        playSound(i);
                    }
                }
              }
              lastTick = currentTick;
              currentTick = (currentTick + 1) % TICKS;
            }, tickTime);
          }
          
          function restartSequencer() {
            if (interval) {
              cancelAnimationFrame(interval.value);
            }
            if (isPlaying) {
              startSequencer();
            }
          }
          
          // Start the sequencer
          startSequencer();
          
          // Initial click to start audio context
          document.body.addEventListener('click', function() {
            if (context && context.state === 'suspended') {
              context.resume();
            }
          }, { once: true });
          
          // Send height to parent iframe
          function updateParentHeight() {
            const height = document.body.scrollHeight;
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({ height: height }, '*');
            }
          }
          
          // Update on load and whenever content changes
          window.addEventListener('load', updateParentHeight);
          window.addEventListener('resize', updateParentHeight);
          
          // Update periodically
          setInterval(updateParentHeight, 500);
        }());
    </script>
</body>
</html>
